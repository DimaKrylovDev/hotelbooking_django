{% extends "main/layout.html" %}

{% block content %}
<style>
    .room-detail-wrapper {
        padding: 1rem 0 3rem;
        display: grid;
        gap: 1.5rem;
    }

    .room-card {
        background: white;
        border-radius: var(--border-radius);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        padding: 2rem;
        display: grid;
        gap: 1.25rem;
    }

    .room-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .room-title {
        margin: 0;
        color: var(--primary-color);
        font-size: 1.75rem;
        font-weight: 700;
    }

    .room-meta {
        display: grid;
        gap: 0.5rem;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    }

    .room-meta-item {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
    }

    .room-meta-label {
        color: #6b7a90;
        font-size: 0.9rem;
        font-weight: 500;
    }

    .room-meta-value {
        color: var(--dark-color);
        font-size: 1rem;
        font-weight: 600;
    }

    .room-photo-placeholder {
        background: #f6f8fb;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        padding: 0.5rem;
        display: grid;
        place-items: center;
        height: 300px;
        color: #6b7a90;
    }

    .photo-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        border-radius: var(--border-radius);
        overflow: hidden;
    }

    .photo-grid-main {
        grid-row: span 2;
        position: relative;
        border-radius: 12px;
        overflow: hidden;
    }

    .photo-grid-main img {
        width: 100%;
        height: 100%;
        min-height: 400px;
        object-fit: cover;
        cursor: pointer;
        transition: transform 0.3s ease;
    }

    .photo-grid-main img:hover {
        transform: scale(1.02);
    }

    .photo-grid-side {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
    }

    .photo-grid-item {
        position: relative;
        border-radius: 10px;
        overflow: hidden;
        aspect-ratio: 4/3;
    }

    .photo-grid-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        cursor: pointer;
        transition: transform 0.3s ease;
    }

    .photo-grid-item img:hover {
        transform: scale(1.05);
    }

    .photo-grid-item.more-photos {
        position: relative;
    }

    .photo-grid-item.more-photos::after {
        content: attr(data-more);
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        display: grid;
        place-items: center;
        color: white;
        font-size: 1.25rem;
        font-weight: 700;
    }

    @media (max-width: 600px) {
        .photo-grid {
            grid-template-columns: 1fr;
        }
        .photo-grid-main {
            grid-row: auto;
        }
        .photo-grid-main img {
            min-height: 250px;
        }
    }

    /* Lightbox */
    .lightbox {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.92);
        z-index: 9999;
        place-items: center;
        padding: 1rem;
    }

    .lightbox.active {
        display: grid;
    }

    .lightbox-close {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: none;
        border: none;
        color: white;
        font-size: 2.5rem;
        cursor: pointer;
        z-index: 10;
    }

    .lightbox-img {
        max-width: 90vw;
        max-height: 85vh;
        object-fit: contain;
        border-radius: 8px;
    }

    .lightbox-nav {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(255,255,255,0.15);
        border: none;
        color: white;
        font-size: 2rem;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        cursor: pointer;
        transition: background 0.2s;
    }

    .lightbox-nav:hover {
        background: rgba(255,255,255,0.3);
    }

    .lightbox-prev {
        left: 1rem;
    }

    .lightbox-next {
        right: 1rem;
    }

    .amenities {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .amenity {
        padding: 0.35rem 0.75rem;
        background: var(--light-color);
        border-radius: 999px;
        font-size: 0.9rem;
    }

    .actions {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
    }

    .reviews-card {
        background: white;
        border-radius: var(--border-radius);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        padding: 2rem;
        display: grid;
        gap: 1rem;
    }

    .review-item {
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 1rem;
        margin-bottom: 1rem;
    }

    .review-item:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }

    .review-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.75rem;
        flex-wrap: wrap;
    }

    .review-author {
        font-weight: 600;
        color: var(--dark-color);
    }

    .review-meta {
        color: #6b7a90;
        font-size: 0.9rem;
    }

    .rating {
        color: #f59e0b;
        font-weight: 700;
    }

    .empty-reviews {
        padding: 1rem;
        text-align: center;
        color: #6b7a90;
        border: 1px dashed var(--border-color);
        border-radius: var(--border-radius);
    }

    @media (max-width: 768px) {
        .room-card, .reviews-card {
            padding: 1.5rem;
        }
    }
</style>

<div class="room-detail-wrapper">
    <div class="room-card">
        <div class="room-header">
            <h1 class="room-title">{{ room.get_room_type_display }} ‚Äî {{ room.price_per_night }} ‚ÇΩ/–Ω–æ—á—å</h1>
            <div class="actions">
                {% if request.user.is_authenticated and room.room_owner != request.user %}
                    <a href="{% url 'booking_create' room_id=room.id %}" class="btn" style="width:auto;">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</a>
                {% endif %}
                <button type="button" onclick="history.back()" class="btn btn-secondary" style="width:auto;">‚Üê –ù–∞–∑–∞–¥</button>
            </div>
        </div>

        {% if all_photos %}
        <div class="photo-grid">
            <div class="photo-grid-main">
                <img src="{{ all_photos.0 }}" alt="–§–æ—Ç–æ –Ω–æ–º–µ—Ä–∞" data-index="0" class="gallery-photo">
            </div>
            <div class="photo-grid-side">
                {% for photo_url in all_photos|slice:"1:5" %}
                    <div class="photo-grid-item{% if forloop.counter == 4 and extra_photos_count > 0 %} more-photos{% endif %}"{% if forloop.counter == 4 and extra_photos_count > 0 %} data-more="+{{ extra_photos_count }}"{% endif %}>
                        <img src="{{ photo_url }}" alt="–§–æ—Ç–æ" data-index="{{ forloop.counter }}" class="gallery-photo">
                    </div>
                {% endfor %}
            </div>
        </div>
        {% else %}
        <div class="room-photo-placeholder">
            üì∑ –§–æ—Ç–æ –ø–æ–∫–∞ –Ω–µ—Ç
        </div>
        {% endif %}

        <div class="room-meta">
            <div class="room-meta-item">
                <span class="room-meta-label">–ê–¥—Ä–µ—Å</span>
                <span class="room-meta-value">{{ room.address }}</span>
            </div>
            <div class="room-meta-item">
                <span class="room-meta-label">–í–º–µ—Å—Ç–∏–º–æ—Å—Ç—å</span>
                <span class="room-meta-value">{{ room.capacity }} —á–µ–ª.</span>
            </div>
            <div class="room-meta-item">
                <span class="room-meta-label">–†–∞–∑–º–µ—Ä</span>
                <span class="room-meta-value">{{ room.size|default:"–ù–µ —É–∫–∞–∑–∞–Ω" }}</span>
            </div>
            <div class="room-meta-item">
                <span class="room-meta-label">–°—Ç–∞—Ç—É—Å</span>
                <span class="room-meta-value">{% if room.is_active %}–ê–∫—Ç–∏–≤–Ω–∞{% else %}–ù–µ–∞–∫—Ç–∏–≤–Ω–∞{% endif %}</span>
            </div>
        </div>

        {% if room.amenities_list %}
        <div class="amenities">
            {% for amenity in room.amenities_list %}
                <span class="amenity">{{ amenity }}</span>
            {% endfor %}
        </div>
        {% endif %}
    </div>

    <div class="reviews-card">
        <div class="room-header" style="margin-bottom:0.5rem;">
            <h2 class="room-title" style="font-size:1.4rem;">–û—Ç–∑—ã–≤—ã</h2>
            {% if request.user.is_authenticated %}
                <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
                    <a href="{% url 'reviews' %}?room={{ room.id }}" class="btn btn-secondary" style="width:auto;">–í—Å–µ –æ—Ç–∑—ã–≤—ã</a>
                    {% if user_booking_for_room %}
                        <a href="{% url 'review_create' booking_id=user_booking_for_room.id %}" class="btn" style="width:auto;">–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</a>
                    {% else %}
                        <span class="btn" style="width:auto; background:#6c757d; cursor:not-allowed; opacity:0.6;">–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</span>
                    {% endif %}
                </div>
            {% endif %}
        </div>

        {% if reviews %}
            {% for review in reviews %}
                <div class="review-item">
                    <div class="review-top">
                        <div>
                            <div class="review-author">{{ review.guest.get_full_name|default:review.guest.email }}</div>
                            <div class="review-meta">{{ review.created_at|date:"d.m.Y H:i" }}</div>
                        </div>
                        <div class="rating">‚≠ê {{ review.rating }}/5</div>
                    </div>
                    {% if review.review_text %}
                        <div class="review-text">{{ review.review_text }}</div>
                    {% else %}
                        <div class="review-text" style="color:#6b7a90;">–ë–µ–∑ —Ç–µ–∫—Å—Ç–∞ –æ—Ç–∑—ã–≤–∞</div>
                    {% endif %}
                </div>
            {% endfor %}
        {% else %}
            <div class="empty-reviews">–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤.</div>
        {% endif %}
    </div>
</div>
<!-- Lightbox Modal -->
<div class="lightbox" id="lightbox" data-photos='[{% for url in all_photos %}"{{ url }}"{% if not forloop.last %},{% endif %}{% endfor %}]'>
    <button class="lightbox-close" id="lightbox-close">&times;</button>
    <button class="lightbox-nav lightbox-prev" id="lightbox-prev">&#10094;</button>
    <img class="lightbox-img" id="lightbox-img" src="" alt="–§–æ—Ç–æ">
    <button class="lightbox-nav lightbox-next" id="lightbox-next">&#10095;</button>
</div>

<script>
(function() {
    var lightbox = document.getElementById('lightbox');
    var lightboxImg = document.getElementById('lightbox-img');
    var allPhotos = [];
    var currentIndex = 0;

    try {
        allPhotos = JSON.parse(lightbox.getAttribute('data-photos') || '[]');
    } catch(e) {
        allPhotos = [];
    }

    var photos = document.querySelectorAll('.gallery-photo');

    photos.forEach(function(img) {
        img.addEventListener('click', function() {
            currentIndex = parseInt(img.getAttribute('data-index')) || 0;
            if (allPhotos[currentIndex]) {
                lightboxImg.src = allPhotos[currentIndex];
                lightbox.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
        });
    });

    function closeLightbox() {
        lightbox.classList.remove('active');
        document.body.style.overflow = '';
    }

    function navigateLightbox(dir) {
        currentIndex += dir;
        if (currentIndex < 0) currentIndex = allPhotos.length - 1;
        if (currentIndex >= allPhotos.length) currentIndex = 0;
        if (allPhotos[currentIndex]) {
            lightboxImg.src = allPhotos[currentIndex];
        }
    }

    document.getElementById('lightbox-close').addEventListener('click', closeLightbox);
    document.getElementById('lightbox-prev').addEventListener('click', function() { navigateLightbox(-1); });
    document.getElementById('lightbox-next').addEventListener('click', function() { navigateLightbox(1); });

    lightbox.addEventListener('click', function(e) {
        if (e.target === lightbox) closeLightbox();
    });

    document.addEventListener('keydown', function(e) {
        if (!lightbox.classList.contains('active')) return;
        if (e.key === 'Escape') closeLightbox();
        if (e.key === 'ArrowLeft') navigateLightbox(-1);
        if (e.key === 'ArrowRight') navigateLightbox(1);
    });
})();
</script>
{% endblock %}

